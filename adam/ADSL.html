<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>pharmaverse examples - ADSL</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../adsl.qmd" rel="next">
<link href="../adam/adppk.html" rel="prev">
<link href="../assets/img/pharmaverse.png" rel="icon" type="image/png">
<script src="../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script><style>html{ scroll-behavior: smooth; }</style>
<link rel="stylesheet" href="../assets/css/style.scss">
<meta property="og:title" content="pharmaverse examples - ADSL">
<meta property="og:description" content="This guide will show you how four pharmaverse packages, along with some from tidyverse, can be used to create an ADaM such as ADSL end-to-end, using pharmaversesdtm SDTM data as input.">
<meta property="og:site-name" content="`pharmaverse` examples">
</head>
<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title"><code>pharmaverse</code> examples</span>
    </a>
  </div>
          <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://pharmaverse.org"><i class="bi bi-house" role="img" aria-label="pharmaverse">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://app.slack.com/client/T028PB489D3/"><i class="bi bi-slack" role="img" aria-label="Slack">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pharmaverse/examples"><i class="bi bi-github" role="img" aria-label="Repository">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-toggle-container">
                <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
                <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
            </div>
            <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">ADSL</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
      <a href="../index.html" class="sidebar-logo-link">
      <img src="../assets/img/pharmaverse.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none"></a>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">SDTM</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../sdtm/examples.html" class="sidebar-item-text sidebar-link">SDTM Examples</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">ADAM</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../adam/adpc.html" class="sidebar-item-text sidebar-link">ADPC</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../adam/adppk.html" class="sidebar-item-text sidebar-link">ADPPK</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../adam/ADSL.html" class="sidebar-item-text sidebar-link active">ADSL</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../tlg/index.html" class="sidebar-item-text sidebar-link">TLG</a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tlg/test.html" class="sidebar-item-text sidebar-link">test</a>
  </div>
</li>
      </ul>
</li>
        <li class="px-0"><hr class="sidebar-divider hi "></li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../session.html" class="sidebar-item-text sidebar-link">Session Info</a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar -->
<!-- main -->
<main class="content column-page-right" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">ADSL</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="introduction" class="level2"><h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This guide will show you how four pharmaverse packages, along with some from tidyverse, can be used to create an ADaM such as <code>ADSL</code> end-to-end, using <a href="https://pharmaverse.github.io/pharmaversesdtm/main/">pharmaversesdtm</a> SDTM data as input.</p>
<p>The four packages used with a brief description of their purpose are as follows:</p>
<ul>
<li>
<a href="https://atorus-research.github.io/metacore/"><code>{metacore}</code></a>: provides harmonized metadata/specifications object.</li>
<li>
<a href="https://pharmaverse.github.io/metatools/"><code>{metatools}</code></a>: uses the provided metadata to build/enhance and check the dataset.</li>
<li>
<a href="https://pharmaverse.github.io/admiral/index.html"><code>{admiral}</code></a>: provides the ADaM derivations.</li>
<li>
<a href="https://atorus-research.github.io/xportr/"><code>{xportr}</code></a>: delivers the SAS transport file (XPT) and eSub checks.</li>
</ul>
<p>It is important to understand <a href="https://atorus-research.github.io/metacore/">metacore</a> objects by reading through the above linked package site, as these are fundamental to being able to use <a href="https://pharmaverse.github.io/metatools/">metatools</a> and <a href="https://github.com/atorus-research/xportr">xportr</a>. Each company may need to build a specification reader to create these objects from their source standard specification templates.</p>
</section><section id="load-data-and-required-pharmaverse-packages" class="level2"><h2 class="anchored" data-anchor-id="load-data-and-required-pharmaverse-packages">Load Data and Required pharmaverse Packages</h2>
<p>The first step is to load our pharmaverse packages and input data. Below shows the versions of each of these package used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">library</span>(metacore)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(metatools)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">library</span>(pharmaversesdtm)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">library</span>(admiral)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">library</span>(xportr)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">library</span>(stringr)</span>
<span id="cb1-10"><a href="#cb1-10"></a></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co"># All our examples use the latest CRAN versions of packages each time the book is</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co"># deployed, but in case interested here are the versions</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">packageVersion</span>(<span class="st">"metacore"</span>)</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="fu">packageVersion</span>(<span class="st">"metatools"</span>)</span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="fu">packageVersion</span>(<span class="st">"admiral"</span>)</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="fu">packageVersion</span>(<span class="st">"xportr"</span>)</span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co"># Read in input SDTM data </span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="fu">data</span>(<span class="st">"dm"</span>)</span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="fu">data</span>(<span class="st">"ex"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] '0.1.2'
[1] '0.1.5'
[1] '0.12.3'
[1] '0.3.1'</code></pre>
</div>
</div>
<p>Next we need to load the specification file in the form of a <a href="https://atorus-research.github.io/metacore/">metacore</a> object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="co"># Read in metacore object </span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">load</span>(<span class="fu">metacore_example</span>(<span class="st">"pilot_ADaM.rda"</span>))</span>
<span id="cb3-3"><a href="#cb3-3"></a>metacore <span class="ot">&lt;-</span> metacore <span class="sc">%&gt;%</span> </span>
<span id="cb3-4"><a href="#cb3-4"></a>   <span class="fu">select_dataset</span>(<span class="st">"ADSL"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here is an example of how a <a href="https://atorus-research.github.io/metacore/">metacore</a> object looks showing variable level metadata:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>metacore<span class="sc">$</span>ds_vars</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 49 × 7
   dataset variable key_seq order keep  core  supp_flag
   &lt;chr&gt;   &lt;chr&gt;      &lt;int&gt; &lt;int&gt; &lt;lgl&gt; &lt;chr&gt; &lt;lgl&gt;    
 1 ADSL    STUDYID       NA     1 FALSE &lt;NA&gt;  NA       
 2 ADSL    USUBJID        1     2 FALSE &lt;NA&gt;  NA       
 3 ADSL    SUBJID        NA     3 FALSE &lt;NA&gt;  NA       
 4 ADSL    SITEID        NA     4 FALSE &lt;NA&gt;  NA       
 5 ADSL    SITEGR1       NA     5 FALSE &lt;NA&gt;  NA       
 6 ADSL    ARM           NA     6 FALSE &lt;NA&gt;  NA       
 7 ADSL    TRT01P        NA     7 FALSE &lt;NA&gt;  NA       
 8 ADSL    TRT01PN       NA     8 FALSE &lt;NA&gt;  NA       
 9 ADSL    TRT01A        NA     9 FALSE &lt;NA&gt;  NA       
10 ADSL    TRT01AN       NA    10 FALSE &lt;NA&gt;  NA       
# ℹ 39 more rows</code></pre>
</div>
</div>
</section><section id="start-building-derivations" class="level2"><h2 class="anchored" data-anchor-id="start-building-derivations">Start Building Derivations</h2>
<p>The first derivation step we are going to do is to pull through all the columns that come directly from the SDTM datasets. You might know which datasets you are going to pull from directly already, but if you don’t you can call <code><a href="https://pharmaverse.github.io/metatools/reference/build_from_derived.html">metatools::build_from_derived()</a></code> with just an empty list and the error will tell you which datasets you need to supply.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">build_from_derived</span>(metacore, <span class="fu">list</span>(), <span class="at">predecessor_only =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in build_from_derived(metacore, list(), predecessor_only = FALSE): Not all datasets provided. Please pass the following dataset(s):
DM</code></pre>
</div>
</div>
<p>In this case all the columns come from <code>DM</code> so that is the only dataset we will pass into <code><a href="https://pharmaverse.github.io/metatools/reference/build_from_derived.html">metatools::build_from_derived()</a></code>. The resulting dataset has all the columns combined and any columns that needed renaming between SDTM and ADaM are renamed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>adsl_preds <span class="ot">&lt;-</span> <span class="fu">build_from_derived</span>(metacore, </span>
<span id="cb8-2"><a href="#cb8-2"></a>                                 <span class="at">ds_list =</span> <span class="fu">list</span>(<span class="st">"dm"</span> <span class="ot">=</span> dm), </span>
<span id="cb8-3"><a href="#cb8-3"></a>                                 <span class="at">predecessor_only =</span> <span class="cn">FALSE</span>, <span class="at">keep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="fu">head</span>(adsl_preds, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 14
   STUDYID      USUBJID SUBJID SITEID ARM     AGE AGEU  RACE  SEX   ETHNIC DTHFL
   &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;
 1 CDISCPILOT01 01-701… 1015   701    Plac…    63 YEARS WHITE F     HISPA… &lt;NA&gt; 
 2 CDISCPILOT01 01-701… 1023   701    Plac…    64 YEARS WHITE M     HISPA… &lt;NA&gt; 
 3 CDISCPILOT01 01-701… 1028   701    Xano…    71 YEARS WHITE M     NOT H… &lt;NA&gt; 
 4 CDISCPILOT01 01-701… 1033   701    Xano…    74 YEARS WHITE M     NOT H… &lt;NA&gt; 
 5 CDISCPILOT01 01-701… 1034   701    Xano…    77 YEARS WHITE F     NOT H… &lt;NA&gt; 
 6 CDISCPILOT01 01-701… 1047   701    Plac…    85 YEARS WHITE F     NOT H… &lt;NA&gt; 
 7 CDISCPILOT01 01-701… 1057   701    Scre…    59 YEARS WHITE F     HISPA… &lt;NA&gt; 
 8 CDISCPILOT01 01-701… 1097   701    Xano…    68 YEARS WHITE M     NOT H… &lt;NA&gt; 
 9 CDISCPILOT01 01-701… 1111   701    Xano…    81 YEARS WHITE F     NOT H… &lt;NA&gt; 
10 CDISCPILOT01 01-701… 1115   701    Xano…    84 YEARS WHITE M     NOT H… &lt;NA&gt; 
# ℹ 3 more variables: RFSTDTC &lt;chr&gt;, RFENDTC &lt;chr&gt;, TRT01P &lt;chr&gt;</code></pre>
</div>
</div>
<p>Now we have the base dataset, we can start to create some variables. We can start with creating the subgroups using the controlled terminology, in this case <code>AGEGR1</code>. The metacore object holds all the metadata needed to make <code>ADSL</code>. Part of that metadata is the controlled terminology, which can help automate the creation of subgroups. We can look into the <a href="https://atorus-research.github.io/metacore/">metacore</a> object and see the controlled terminology for <code>AGEGR1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">get_control_term</span>(metacore, <span class="at">variable =</span> AGEGR1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  code  decode
  &lt;chr&gt; &lt;chr&gt; 
1 &lt;65   &lt;65   
2 65-80 65-80 
3 &gt;80   &gt;80   </code></pre>
</div>
</div>
<p>Because this controlled terminology is written in a fairly standard format we can automate the creation of <code>AGEGR1</code>. The function <code><a href="https://pharmaverse.github.io/metatools/reference/create_cat_var.html">metatools::create_cat_var()</a></code> takes in a <a href="https://atorus-research.github.io/metacore/">metacore</a> object, a reference variable - in this case <code>AGE</code> because that is the continuous variable <code>AGEGR1</code> is created from, and the name of the sub-grouped variable. It will take the controlled terminology from the sub-grouped variable and group the reference variables accordingly.</p>
<p>Using a similar philosophy we can create the numeric version of <code>RACE</code> using the controlled terminology stored in the <a href="https://atorus-research.github.io/metacore/">metacore</a> object with the <code><a href="https://pharmaverse.github.io/metatools/reference/create_var_from_codelist.html">metatools::create_var_from_codelist()</a></code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>adsl_ct <span class="ot">&lt;-</span> adsl_preds <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2"></a>   <span class="fu">create_cat_var</span>(metacore, <span class="at">ref_var =</span> AGE, </span>
<span id="cb12-3"><a href="#cb12-3"></a>                  <span class="at">grp_var =</span> AGEGR1, <span class="at">num_grp_var =</span> AGEGR1N) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4"></a>   <span class="fu">create_var_from_codelist</span>(<span class="at">metacore =</span> metacore, </span>
<span id="cb12-5"><a href="#cb12-5"></a>                            <span class="at">input_var =</span> RACE, </span>
<span id="cb12-6"><a href="#cb12-6"></a>                            <span class="at">out_var =</span> RACEN) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7"></a>   <span class="co">#Removing screen failures from ARM and TRT01P to match the define and FDA guidence</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>   <span class="fu">mutate</span>(<span class="at">ARM =</span> <span class="fu">if_else</span>(ARM <span class="sc">==</span> <span class="st">"Screen Failure"</span>, <span class="cn">NA_character_</span>, ARM),</span>
<span id="cb12-9"><a href="#cb12-9"></a>          <span class="at">TRT01P =</span> <span class="fu">if_else</span>(TRT01P <span class="sc">==</span> <span class="st">"Screen Failure"</span>, <span class="cn">NA_character_</span>, TRT01P)</span>
<span id="cb12-10"><a href="#cb12-10"></a>   )</span>
<span id="cb12-11"><a href="#cb12-11"></a></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="fu">head</span>(adsl_ct, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 17
   STUDYID      USUBJID SUBJID SITEID ARM     AGE AGEU  RACE  SEX   ETHNIC DTHFL
   &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;
 1 CDISCPILOT01 01-701… 1015   701    Plac…    63 YEARS WHITE F     HISPA… &lt;NA&gt; 
 2 CDISCPILOT01 01-701… 1023   701    Plac…    64 YEARS WHITE M     HISPA… &lt;NA&gt; 
 3 CDISCPILOT01 01-701… 1028   701    Xano…    71 YEARS WHITE M     NOT H… &lt;NA&gt; 
 4 CDISCPILOT01 01-701… 1033   701    Xano…    74 YEARS WHITE M     NOT H… &lt;NA&gt; 
 5 CDISCPILOT01 01-701… 1034   701    Xano…    77 YEARS WHITE F     NOT H… &lt;NA&gt; 
 6 CDISCPILOT01 01-701… 1047   701    Plac…    85 YEARS WHITE F     NOT H… &lt;NA&gt; 
 7 CDISCPILOT01 01-701… 1057   701    &lt;NA&gt;     59 YEARS WHITE F     HISPA… &lt;NA&gt; 
 8 CDISCPILOT01 01-701… 1097   701    Xano…    68 YEARS WHITE M     NOT H… &lt;NA&gt; 
 9 CDISCPILOT01 01-701… 1111   701    Xano…    81 YEARS WHITE F     NOT H… &lt;NA&gt; 
10 CDISCPILOT01 01-701… 1115   701    Xano…    84 YEARS WHITE M     NOT H… &lt;NA&gt; 
# ℹ 6 more variables: RFSTDTC &lt;chr&gt;, RFENDTC &lt;chr&gt;, TRT01P &lt;chr&gt;, AGEGR1 &lt;chr&gt;,
#   AGEGR1N &lt;dbl&gt;, RACEN &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Now we have sorted out what we can easily do with controlled terminology it is time to start deriving some variables. Here you could refer directly to using the <a href="https://pharmaverse.github.io/admiral/">admiral</a> template and <a href="https://pharmaverse.github.io/admiral/cran-release/articles/adsl.html">vignette</a> in practice, but for the purpose of this end-to-end ADaM vignette we will share a few exposure derivations from there. We derive the start and end of treatment (which requires dates to first be converted from DTC to DTM), the treatment duration, and the safety population flag.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>ex_ext <span class="ot">&lt;-</span> ex <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="fu">derive_vars_dtm</span>(</span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="at">dtc =</span> EXSTDTC,</span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="at">new_vars_prefix =</span> <span class="st">"EXST"</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>  <span class="fu">derive_vars_dtm</span>(</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="at">dtc =</span> EXENDTC,</span>
<span id="cb14-8"><a href="#cb14-8"></a>    <span class="at">new_vars_prefix =</span> <span class="st">"EXEN"</span>,</span>
<span id="cb14-9"><a href="#cb14-9"></a>    <span class="at">time_imputation =</span> <span class="st">"last"</span></span>
<span id="cb14-10"><a href="#cb14-10"></a>  )</span>
<span id="cb14-11"><a href="#cb14-11"></a></span>
<span id="cb14-12"><a href="#cb14-12"></a>adsl_raw <span class="ot">&lt;-</span> adsl_ct <span class="sc">%&gt;%</span></span>
<span id="cb14-13"><a href="#cb14-13"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb14-14"><a href="#cb14-14"></a>    <span class="at">dataset_add =</span> ex_ext,</span>
<span id="cb14-15"><a href="#cb14-15"></a>    <span class="at">filter_add =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span></span>
<span id="cb14-16"><a href="#cb14-16"></a>      (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>        <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>))) <span class="sc">&amp;</span> <span class="fu">nchar</span>(EXSTDTC) <span class="sc">&gt;=</span> <span class="dv">10</span>,</span>
<span id="cb14-18"><a href="#cb14-18"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(<span class="at">TRTSDTM =</span> EXSTDTM),</span>
<span id="cb14-19"><a href="#cb14-19"></a>    <span class="at">order =</span> <span class="fu">exprs</span>(EXSTDTM, EXSEQ),</span>
<span id="cb14-20"><a href="#cb14-20"></a>    <span class="at">mode =</span> <span class="st">"first"</span>,</span>
<span id="cb14-21"><a href="#cb14-21"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID)</span>
<span id="cb14-22"><a href="#cb14-22"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-23"><a href="#cb14-23"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb14-24"><a href="#cb14-24"></a>    <span class="at">dataset_add =</span> ex_ext,</span>
<span id="cb14-25"><a href="#cb14-25"></a>    <span class="at">filter_add =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>      (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb14-27"><a href="#cb14-27"></a>        <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>))) <span class="sc">&amp;</span> <span class="fu">nchar</span>(EXENDTC) <span class="sc">&gt;=</span> <span class="dv">10</span>,</span>
<span id="cb14-28"><a href="#cb14-28"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(<span class="at">TRTEDTM =</span> EXENDTM),</span>
<span id="cb14-29"><a href="#cb14-29"></a>    <span class="at">order =</span> <span class="fu">exprs</span>(EXENDTM, EXSEQ),</span>
<span id="cb14-30"><a href="#cb14-30"></a>    <span class="at">mode =</span> <span class="st">"last"</span>,</span>
<span id="cb14-31"><a href="#cb14-31"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID)</span>
<span id="cb14-32"><a href="#cb14-32"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-33"><a href="#cb14-33"></a>   <span class="fu">derive_vars_dtm_to_dt</span>(<span class="at">source_vars =</span> <span class="fu">exprs</span>(TRTSDTM, TRTEDTM)) <span class="sc">%&gt;%</span>  <span class="co">#Convert Datetime variables to date </span></span>
<span id="cb14-34"><a href="#cb14-34"></a>   <span class="fu">derive_var_trtdurd</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-35"><a href="#cb14-35"></a>   <span class="fu">derive_var_merged_exist_flag</span>(</span>
<span id="cb14-36"><a href="#cb14-36"></a>     <span class="at">dataset_add =</span> ex,</span>
<span id="cb14-37"><a href="#cb14-37"></a>     <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID),</span>
<span id="cb14-38"><a href="#cb14-38"></a>     <span class="at">new_var =</span> SAFFL,</span>
<span id="cb14-39"><a href="#cb14-39"></a>     <span class="at">condition =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span> (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>)))</span>
<span id="cb14-40"><a href="#cb14-40"></a>   ) <span class="sc">%&gt;%</span> </span>
<span id="cb14-41"><a href="#cb14-41"></a>   <span class="fu">drop_unspec_vars</span>(metacore) <span class="co">#This will drop any columns that aren't specified in the metacore object</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>The following variable(s) were dropped:
  TRTSDTM
  TRTEDTM</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="fu">head</span>(adsl_raw, <span class="at">n=</span><span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 21
   STUDYID      USUBJID SUBJID SITEID ARM     AGE AGEU  RACE  SEX   ETHNIC DTHFL
   &lt;chr&gt;        &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;
 1 CDISCPILOT01 01-701… 1015   701    Plac…    63 YEARS WHITE F     HISPA… &lt;NA&gt; 
 2 CDISCPILOT01 01-701… 1023   701    Plac…    64 YEARS WHITE M     HISPA… &lt;NA&gt; 
 3 CDISCPILOT01 01-701… 1028   701    Xano…    71 YEARS WHITE M     NOT H… &lt;NA&gt; 
 4 CDISCPILOT01 01-701… 1033   701    Xano…    74 YEARS WHITE M     NOT H… &lt;NA&gt; 
 5 CDISCPILOT01 01-701… 1034   701    Xano…    77 YEARS WHITE F     NOT H… &lt;NA&gt; 
 6 CDISCPILOT01 01-701… 1047   701    Plac…    85 YEARS WHITE F     NOT H… &lt;NA&gt; 
 7 CDISCPILOT01 01-701… 1057   701    &lt;NA&gt;     59 YEARS WHITE F     HISPA… &lt;NA&gt; 
 8 CDISCPILOT01 01-701… 1097   701    Xano…    68 YEARS WHITE M     NOT H… &lt;NA&gt; 
 9 CDISCPILOT01 01-701… 1111   701    Xano…    81 YEARS WHITE F     NOT H… &lt;NA&gt; 
10 CDISCPILOT01 01-701… 1115   701    Xano…    84 YEARS WHITE M     NOT H… &lt;NA&gt; 
# ℹ 10 more variables: RFSTDTC &lt;chr&gt;, RFENDTC &lt;chr&gt;, TRT01P &lt;chr&gt;,
#   AGEGR1 &lt;chr&gt;, AGEGR1N &lt;dbl&gt;, RACEN &lt;dbl&gt;, TRTSDT &lt;date&gt;, TRTEDT &lt;date&gt;,
#   TRTDURD &lt;dbl&gt;, SAFFL &lt;chr&gt;</code></pre>
</div>
</div>
</section><section id="apply-metadata-to-create-an-esub-xpt-and-perform-associated-checks" class="level2"><h2 class="anchored" data-anchor-id="apply-metadata-to-create-an-esub-xpt-and-perform-associated-checks">Apply Metadata to Create an eSub XPT and Perform Associated Checks</h2>
<p>Now we have all the variables defined we can run some checks before applying the necessary formatting. The top four functions performing checks and sorting/ordering come from <a href="https://pharmaverse.github.io/metatools/">metatools</a>, whereas the others focused around applying attributes to prepare for XPT come from <a href="https://github.com/atorus-research/xportr">xportr</a>. At the end you could add a call to <code><a href="https://rdrr.io/pkg/xportr/man/xportr_write.html">xportr::xportr_write()</a></code> to produce the XPT file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>adsl_raw <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2"></a>   <span class="fu">check_variables</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Check all variables specified are present and no more</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>   <span class="fu">check_ct_data</span>(metacore, <span class="at">na_acceptable =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># Checks all variables with CT only contain values within the CT</span></span>
<span id="cb18-4"><a href="#cb18-4"></a>   <span class="fu">order_cols</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Orders the columns according to the spec</span></span>
<span id="cb18-5"><a href="#cb18-5"></a>   <span class="fu">sort_by_key</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Sorts the rows by the sort keys </span></span>
<span id="cb18-6"><a href="#cb18-6"></a>   <span class="fu">xportr_type</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Coerce variable type to match spec</span></span>
<span id="cb18-7"><a href="#cb18-7"></a>   <span class="fu">xportr_length</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Assigns SAS length from a variable level metadata </span></span>
<span id="cb18-8"><a href="#cb18-8"></a>   <span class="fu">xportr_label</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Assigns variable label from metacore specifications </span></span>
<span id="cb18-9"><a href="#cb18-9"></a>   <span class="fu">xportr_df_label</span>(metacore) <span class="co"># Assigns dataset label from metacore specifications</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 306 × 49
   STUDYID     USUBJID SUBJID SITEID SITEGR1 ARM   TRT01P TRT01PN TRT01A TRT01AN
   &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
 1 CDISCPILOT… 01-701… 1015   701    &lt;NA&gt;    Plac… Place…      NA &lt;NA&gt;        NA
 2 CDISCPILOT… 01-701… 1023   701    &lt;NA&gt;    Plac… Place…      NA &lt;NA&gt;        NA
 3 CDISCPILOT… 01-701… 1028   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
 4 CDISCPILOT… 01-701… 1033   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
 5 CDISCPILOT… 01-701… 1034   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
 6 CDISCPILOT… 01-701… 1047   701    &lt;NA&gt;    Plac… Place…      NA &lt;NA&gt;        NA
 7 CDISCPILOT… 01-701… 1057   701    &lt;NA&gt;    &lt;NA&gt;  &lt;NA&gt;        NA &lt;NA&gt;        NA
 8 CDISCPILOT… 01-701… 1097   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
 9 CDISCPILOT… 01-701… 1111   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
10 CDISCPILOT… 01-701… 1115   701    &lt;NA&gt;    Xano… Xanom…      NA &lt;NA&gt;        NA
# ℹ 296 more rows
# ℹ 39 more variables: TRTSDT &lt;date&gt;, TRTEDT &lt;date&gt;, TRTDURD &lt;dbl&gt;,
#   AVGDD &lt;dbl&gt;, CUMDOSE &lt;dbl&gt;, AGE &lt;dbl&gt;, AGEGR1 &lt;chr&gt;, AGEGR1N &lt;dbl&gt;,
#   AGEU &lt;chr&gt;, RACE &lt;chr&gt;, RACEN &lt;dbl&gt;, SEX &lt;chr&gt;, ETHNIC &lt;chr&gt;, SAFFL &lt;chr&gt;,
#   ITTFL &lt;chr&gt;, EFFFL &lt;chr&gt;, COMP8FL &lt;chr&gt;, COMP16FL &lt;chr&gt;, COMP24FL &lt;chr&gt;,
#   DISCONFL &lt;chr&gt;, DSRAEFL &lt;chr&gt;, DTHFL &lt;chr&gt;, BMIBL &lt;dbl&gt;, BMIBLGR1 &lt;chr&gt;,
#   HEIGHTBL &lt;dbl&gt;, WEIGHTBL &lt;dbl&gt;, EDUCLVL &lt;dbl&gt;, DISONSDT &lt;lgl&gt;, …</code></pre>
</div>
</div>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation column-page-right"><div class="nav-page nav-page-previous">
      <a href="../adam/adppk.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">ADPPK</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../adsl.qmd" class="pagination-link">
        <span class="nav-page-text"></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="co">---</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="an">title:</span><span class="co"> "ADSL"</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="co">---</span></span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a><span class="fu">## Introduction</span></span>
<span id="cb20-6"><a href="#cb20-6"></a></span>
<span id="cb20-7"><a href="#cb20-7"></a>This guide will show you how four pharmaverse packages, along with some from</span>
<span id="cb20-8"><a href="#cb20-8"></a>tidyverse, can be used to create an ADaM such as <span class="in">`ADSL`</span> end-to-end, using</span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="in">`{pharmaversesdtm}`</span> SDTM data as input.</span>
<span id="cb20-10"><a href="#cb20-10"></a></span>
<span id="cb20-11"><a href="#cb20-11"></a>The four packages used with a brief description of their purpose are as follows:</span>
<span id="cb20-12"><a href="#cb20-12"></a></span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="ss">* </span><span class="co">[</span><span class="ot">`{metacore}`</span><span class="co">](https://atorus-research.github.io/metacore/)</span>: provides harmonized</span>
<span id="cb20-14"><a href="#cb20-14"></a>metadata/specifications object.</span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="ss">* </span><span class="co">[</span><span class="ot">`{metatools}`</span><span class="co">](https://pharmaverse.github.io/metatools/)</span>: uses the provided</span>
<span id="cb20-16"><a href="#cb20-16"></a>metadata to build/enhance and check the dataset.</span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="ss">* </span><span class="co">[</span><span class="ot">`{admiral}`</span><span class="co">](https://pharmaverse.github.io/admiral/index.html)</span>: provides the</span>
<span id="cb20-18"><a href="#cb20-18"></a>ADaM derivations.</span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="ss">* </span><span class="co">[</span><span class="ot">`{xportr}`</span><span class="co">](https://atorus-research.github.io/xportr/)</span>: delivers the SAS</span>
<span id="cb20-20"><a href="#cb20-20"></a>transport file (XPT) and eSub checks.</span>
<span id="cb20-21"><a href="#cb20-21"></a></span>
<span id="cb20-22"><a href="#cb20-22"></a>It is important to understand <span class="in">`{metacore}`</span> objects by reading through the above</span>
<span id="cb20-23"><a href="#cb20-23"></a>linked package site, as these are fundamental to being able to use <span class="in">`{metatools}`</span></span>
<span id="cb20-24"><a href="#cb20-24"></a>and <span class="in">`{xportr}`</span>. Each company may need to build a specification reader to create</span>
<span id="cb20-25"><a href="#cb20-25"></a>these objects from their source standard specification templates.</span>
<span id="cb20-26"><a href="#cb20-26"></a></span>
<span id="cb20-27"><a href="#cb20-27"></a><span class="fu">## Load Data and Required pharmaverse Packages</span></span>
<span id="cb20-28"><a href="#cb20-28"></a></span>
<span id="cb20-29"><a href="#cb20-29"></a>The first step is to load our pharmaverse packages and input data.</span>
<span id="cb20-30"><a href="#cb20-30"></a>Below shows the versions of each of these package used.</span>
<span id="cb20-31"><a href="#cb20-31"></a></span>
<span id="cb20-32"><a href="#cb20-32"></a><span class="in">```{r setup, message=FALSE, warning=FALSE, results='hold'}</span></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="fu">library</span>(metacore)</span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="fu">library</span>(metatools)</span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="fu">library</span>(pharmaversesdtm)</span>
<span id="cb20-36"><a href="#cb20-36"></a><span class="fu">library</span>(admiral)</span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="fu">library</span>(xportr)</span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb20-39"><a href="#cb20-39"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb20-41"><a href="#cb20-41"></a><span class="fu">library</span>(stringr)</span>
<span id="cb20-42"><a href="#cb20-42"></a></span>
<span id="cb20-43"><a href="#cb20-43"></a><span class="co"># All our examples use the latest CRAN versions of packages each time the book is</span></span>
<span id="cb20-44"><a href="#cb20-44"></a><span class="co"># deployed, but in case interested here are the versions</span></span>
<span id="cb20-45"><a href="#cb20-45"></a><span class="fu">packageVersion</span>(<span class="st">"metacore"</span>)</span>
<span id="cb20-46"><a href="#cb20-46"></a><span class="fu">packageVersion</span>(<span class="st">"metatools"</span>)</span>
<span id="cb20-47"><a href="#cb20-47"></a><span class="fu">packageVersion</span>(<span class="st">"admiral"</span>)</span>
<span id="cb20-48"><a href="#cb20-48"></a><span class="fu">packageVersion</span>(<span class="st">"xportr"</span>)</span>
<span id="cb20-49"><a href="#cb20-49"></a></span>
<span id="cb20-50"><a href="#cb20-50"></a><span class="co"># Read in input SDTM data </span></span>
<span id="cb20-51"><a href="#cb20-51"></a><span class="fu">data</span>(<span class="st">"dm"</span>)</span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="fu">data</span>(<span class="st">"ex"</span>)</span>
<span id="cb20-53"><a href="#cb20-53"></a><span class="in">```</span></span>
<span id="cb20-54"><a href="#cb20-54"></a></span>
<span id="cb20-55"><a href="#cb20-55"></a>Next we need to load the specification file in the form of a <span class="in">`{metacore}`</span> object.</span>
<span id="cb20-56"><a href="#cb20-56"></a></span>
<span id="cb20-57"><a href="#cb20-57"></a><span class="in">```{r metacore, warning=FALSE, results='hold'}</span></span>
<span id="cb20-58"><a href="#cb20-58"></a><span class="co"># Read in metacore object </span></span>
<span id="cb20-59"><a href="#cb20-59"></a><span class="fu">load</span>(<span class="fu">metacore_example</span>(<span class="st">"pilot_ADaM.rda"</span>))</span>
<span id="cb20-60"><a href="#cb20-60"></a>metacore <span class="ot">&lt;-</span> metacore <span class="sc">%&gt;%</span> </span>
<span id="cb20-61"><a href="#cb20-61"></a>   <span class="fu">select_dataset</span>(<span class="st">"ADSL"</span>)</span>
<span id="cb20-62"><a href="#cb20-62"></a><span class="in">```</span></span>
<span id="cb20-63"><a href="#cb20-63"></a></span>
<span id="cb20-64"><a href="#cb20-64"></a>Here is an example of how a <span class="in">`{metacore}`</span> object looks showing variable level</span>
<span id="cb20-65"><a href="#cb20-65"></a>metadata:</span>
<span id="cb20-66"><a href="#cb20-66"></a></span>
<span id="cb20-69"><a href="#cb20-69"></a><span class="in">```{r}</span></span>
<span id="cb20-70"><a href="#cb20-70"></a>metacore<span class="sc">$</span>ds_vars</span>
<span id="cb20-71"><a href="#cb20-71"></a><span class="in">```</span></span>
<span id="cb20-72"><a href="#cb20-72"></a>  </span>
<span id="cb20-73"><a href="#cb20-73"></a><span class="fu">## Start Building Derivations</span></span>
<span id="cb20-74"><a href="#cb20-74"></a></span>
<span id="cb20-75"><a href="#cb20-75"></a>The first derivation step we are going to do is to pull through all the columns</span>
<span id="cb20-76"><a href="#cb20-76"></a>that come directly from the SDTM datasets. You might know which datasets you are</span>
<span id="cb20-77"><a href="#cb20-77"></a>going to pull from directly already, but if you don't you can call</span>
<span id="cb20-78"><a href="#cb20-78"></a><span class="in">`metatools::build_from_derived()`</span> with just an empty list and the error will tell</span>
<span id="cb20-79"><a href="#cb20-79"></a>you which datasets you need to supply. </span>
<span id="cb20-80"><a href="#cb20-80"></a></span>
<span id="cb20-81"><a href="#cb20-81"></a><span class="in">```{r, error=TRUE}</span></span>
<span id="cb20-82"><a href="#cb20-82"></a><span class="fu">build_from_derived</span>(metacore, <span class="fu">list</span>(), <span class="at">predecessor_only =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-83"><a href="#cb20-83"></a><span class="in">```</span></span>
<span id="cb20-84"><a href="#cb20-84"></a></span>
<span id="cb20-85"><a href="#cb20-85"></a>In this case all the columns come from <span class="in">`DM`</span> so that is the only dataset we will</span>
<span id="cb20-86"><a href="#cb20-86"></a>pass into <span class="in">`metatools::build_from_derived()`</span>. The resulting dataset has all the</span>
<span id="cb20-87"><a href="#cb20-87"></a>columns combined and any columns that needed renaming between SDTM and ADaM are</span>
<span id="cb20-88"><a href="#cb20-88"></a>renamed.</span>
<span id="cb20-89"><a href="#cb20-89"></a></span>
<span id="cb20-90"><a href="#cb20-90"></a><span class="in">```{r demographcis}</span></span>
<span id="cb20-91"><a href="#cb20-91"></a>adsl_preds <span class="ot">&lt;-</span> <span class="fu">build_from_derived</span>(metacore, </span>
<span id="cb20-92"><a href="#cb20-92"></a>                                 <span class="at">ds_list =</span> <span class="fu">list</span>(<span class="st">"dm"</span> <span class="ot">=</span> dm), </span>
<span id="cb20-93"><a href="#cb20-93"></a>                                 <span class="at">predecessor_only =</span> <span class="cn">FALSE</span>, <span class="at">keep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-94"><a href="#cb20-94"></a><span class="fu">head</span>(adsl_preds, <span class="at">n=</span><span class="dv">10</span>)</span>
<span id="cb20-95"><a href="#cb20-95"></a><span class="in">```</span></span>
<span id="cb20-96"><a href="#cb20-96"></a></span>
<span id="cb20-97"><a href="#cb20-97"></a>Now we have the base dataset, we can start to create some variables. We can start</span>
<span id="cb20-98"><a href="#cb20-98"></a>with creating the subgroups using the controlled terminology, in this case <span class="in">`AGEGR1`</span>.</span>
<span id="cb20-99"><a href="#cb20-99"></a>The metacore object holds all the metadata needed to make <span class="in">`ADSL`</span>. Part of that</span>
<span id="cb20-100"><a href="#cb20-100"></a>metadata is the controlled terminology, which can help automate the creation of</span>
<span id="cb20-101"><a href="#cb20-101"></a>subgroups. We can look into the <span class="in">`{metacore}`</span> object and see the controlled</span>
<span id="cb20-102"><a href="#cb20-102"></a>terminology for <span class="in">`AGEGR1`</span>.</span>
<span id="cb20-103"><a href="#cb20-103"></a></span>
<span id="cb20-106"><a href="#cb20-106"></a><span class="in">```{r}</span></span>
<span id="cb20-107"><a href="#cb20-107"></a><span class="fu">get_control_term</span>(metacore, <span class="at">variable =</span> AGEGR1)</span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="in">```</span></span>
<span id="cb20-109"><a href="#cb20-109"></a></span>
<span id="cb20-110"><a href="#cb20-110"></a>Because this controlled terminology is written in a fairly standard format we</span>
<span id="cb20-111"><a href="#cb20-111"></a>can automate the creation of <span class="in">`AGEGR1`</span>. The function <span class="in">`metatools::create_cat_var()`</span></span>
<span id="cb20-112"><a href="#cb20-112"></a>takes in a <span class="in">`{metacore}`</span> object, a reference variable - in this case <span class="in">`AGE`</span> because</span>
<span id="cb20-113"><a href="#cb20-113"></a>that is the continuous variable <span class="in">`AGEGR1`</span> is created from, and the name of the</span>
<span id="cb20-114"><a href="#cb20-114"></a>sub-grouped variable. It will take the controlled terminology from the sub-grouped</span>
<span id="cb20-115"><a href="#cb20-115"></a>variable and group the reference variables accordingly. </span>
<span id="cb20-116"><a href="#cb20-116"></a></span>
<span id="cb20-117"><a href="#cb20-117"></a>Using a similar philosophy we can create the numeric version of <span class="in">`RACE`</span> using the</span>
<span id="cb20-118"><a href="#cb20-118"></a>controlled terminology stored in the <span class="in">`{metacore}`</span> object with the</span>
<span id="cb20-119"><a href="#cb20-119"></a><span class="in">`metatools::create_var_from_codelist()`</span> function.</span>
<span id="cb20-120"><a href="#cb20-120"></a></span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="in">```{r ct}</span></span>
<span id="cb20-122"><a href="#cb20-122"></a>adsl_ct <span class="ot">&lt;-</span> adsl_preds <span class="sc">%&gt;%</span> </span>
<span id="cb20-123"><a href="#cb20-123"></a>   <span class="fu">create_cat_var</span>(metacore, <span class="at">ref_var =</span> AGE, </span>
<span id="cb20-124"><a href="#cb20-124"></a>                  <span class="at">grp_var =</span> AGEGR1, <span class="at">num_grp_var =</span> AGEGR1N) <span class="sc">%&gt;%</span> </span>
<span id="cb20-125"><a href="#cb20-125"></a>   <span class="fu">create_var_from_codelist</span>(<span class="at">metacore =</span> metacore, </span>
<span id="cb20-126"><a href="#cb20-126"></a>                            <span class="at">input_var =</span> RACE, </span>
<span id="cb20-127"><a href="#cb20-127"></a>                            <span class="at">out_var =</span> RACEN) <span class="sc">%&gt;%</span> </span>
<span id="cb20-128"><a href="#cb20-128"></a>   <span class="co">#Removing screen failures from ARM and TRT01P to match the define and FDA guidence</span></span>
<span id="cb20-129"><a href="#cb20-129"></a>   <span class="fu">mutate</span>(<span class="at">ARM =</span> <span class="fu">if_else</span>(ARM <span class="sc">==</span> <span class="st">"Screen Failure"</span>, <span class="cn">NA_character_</span>, ARM),</span>
<span id="cb20-130"><a href="#cb20-130"></a>          <span class="at">TRT01P =</span> <span class="fu">if_else</span>(TRT01P <span class="sc">==</span> <span class="st">"Screen Failure"</span>, <span class="cn">NA_character_</span>, TRT01P)</span>
<span id="cb20-131"><a href="#cb20-131"></a>   )</span>
<span id="cb20-132"><a href="#cb20-132"></a></span>
<span id="cb20-133"><a href="#cb20-133"></a><span class="fu">head</span>(adsl_ct, <span class="at">n=</span><span class="dv">10</span>)</span>
<span id="cb20-134"><a href="#cb20-134"></a><span class="in">```</span></span>
<span id="cb20-135"><a href="#cb20-135"></a></span>
<span id="cb20-136"><a href="#cb20-136"></a>Now we have sorted out what we can easily do with controlled terminology it is</span>
<span id="cb20-137"><a href="#cb20-137"></a>time to start deriving some variables.</span>
<span id="cb20-138"><a href="#cb20-138"></a>Here you could refer directly to using the <span class="in">`{admiral}`</span> template and <span class="co">[</span><span class="ot">vignette</span><span class="co">](https://pharmaverse.github.io/admiral/cran-release/articles/adsl.html)</span></span>
<span id="cb20-139"><a href="#cb20-139"></a>in practice, but for the purpose of this end-to-end ADaM vignette we will share</span>
<span id="cb20-140"><a href="#cb20-140"></a>a few exposure derivations from there.</span>
<span id="cb20-141"><a href="#cb20-141"></a>We derive the start and end of treatment (which requires dates to first be</span>
<span id="cb20-142"><a href="#cb20-142"></a>converted from DTC to DTM), the treatment duration, and the safety population flag.</span>
<span id="cb20-143"><a href="#cb20-143"></a></span>
<span id="cb20-144"><a href="#cb20-144"></a><span class="in">```{r exposure}</span></span>
<span id="cb20-145"><a href="#cb20-145"></a>ex_ext <span class="ot">&lt;-</span> ex <span class="sc">%&gt;%</span></span>
<span id="cb20-146"><a href="#cb20-146"></a>  <span class="fu">derive_vars_dtm</span>(</span>
<span id="cb20-147"><a href="#cb20-147"></a>    <span class="at">dtc =</span> EXSTDTC,</span>
<span id="cb20-148"><a href="#cb20-148"></a>    <span class="at">new_vars_prefix =</span> <span class="st">"EXST"</span></span>
<span id="cb20-149"><a href="#cb20-149"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-150"><a href="#cb20-150"></a>  <span class="fu">derive_vars_dtm</span>(</span>
<span id="cb20-151"><a href="#cb20-151"></a>    <span class="at">dtc =</span> EXENDTC,</span>
<span id="cb20-152"><a href="#cb20-152"></a>    <span class="at">new_vars_prefix =</span> <span class="st">"EXEN"</span>,</span>
<span id="cb20-153"><a href="#cb20-153"></a>    <span class="at">time_imputation =</span> <span class="st">"last"</span></span>
<span id="cb20-154"><a href="#cb20-154"></a>  )</span>
<span id="cb20-155"><a href="#cb20-155"></a></span>
<span id="cb20-156"><a href="#cb20-156"></a>adsl_raw <span class="ot">&lt;-</span> adsl_ct <span class="sc">%&gt;%</span></span>
<span id="cb20-157"><a href="#cb20-157"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb20-158"><a href="#cb20-158"></a>    <span class="at">dataset_add =</span> ex_ext,</span>
<span id="cb20-159"><a href="#cb20-159"></a>    <span class="at">filter_add =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span></span>
<span id="cb20-160"><a href="#cb20-160"></a>      (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb20-161"><a href="#cb20-161"></a>        <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>))) <span class="sc">&amp;</span> <span class="fu">nchar</span>(EXSTDTC) <span class="sc">&gt;=</span> <span class="dv">10</span>,</span>
<span id="cb20-162"><a href="#cb20-162"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(<span class="at">TRTSDTM =</span> EXSTDTM),</span>
<span id="cb20-163"><a href="#cb20-163"></a>    <span class="at">order =</span> <span class="fu">exprs</span>(EXSTDTM, EXSEQ),</span>
<span id="cb20-164"><a href="#cb20-164"></a>    <span class="at">mode =</span> <span class="st">"first"</span>,</span>
<span id="cb20-165"><a href="#cb20-165"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID)</span>
<span id="cb20-166"><a href="#cb20-166"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-167"><a href="#cb20-167"></a>  <span class="fu">derive_vars_merged</span>(</span>
<span id="cb20-168"><a href="#cb20-168"></a>    <span class="at">dataset_add =</span> ex_ext,</span>
<span id="cb20-169"><a href="#cb20-169"></a>    <span class="at">filter_add =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span></span>
<span id="cb20-170"><a href="#cb20-170"></a>      (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span></span>
<span id="cb20-171"><a href="#cb20-171"></a>        <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>))) <span class="sc">&amp;</span> <span class="fu">nchar</span>(EXENDTC) <span class="sc">&gt;=</span> <span class="dv">10</span>,</span>
<span id="cb20-172"><a href="#cb20-172"></a>    <span class="at">new_vars =</span> <span class="fu">exprs</span>(<span class="at">TRTEDTM =</span> EXENDTM),</span>
<span id="cb20-173"><a href="#cb20-173"></a>    <span class="at">order =</span> <span class="fu">exprs</span>(EXENDTM, EXSEQ),</span>
<span id="cb20-174"><a href="#cb20-174"></a>    <span class="at">mode =</span> <span class="st">"last"</span>,</span>
<span id="cb20-175"><a href="#cb20-175"></a>    <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID)</span>
<span id="cb20-176"><a href="#cb20-176"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-177"><a href="#cb20-177"></a>   <span class="fu">derive_vars_dtm_to_dt</span>(<span class="at">source_vars =</span> <span class="fu">exprs</span>(TRTSDTM, TRTEDTM)) <span class="sc">%&gt;%</span>  <span class="co">#Convert Datetime variables to date </span></span>
<span id="cb20-178"><a href="#cb20-178"></a>   <span class="fu">derive_var_trtdurd</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-179"><a href="#cb20-179"></a>   <span class="fu">derive_var_merged_exist_flag</span>(</span>
<span id="cb20-180"><a href="#cb20-180"></a>     <span class="at">dataset_add =</span> ex,</span>
<span id="cb20-181"><a href="#cb20-181"></a>     <span class="at">by_vars =</span> <span class="fu">exprs</span>(STUDYID, USUBJID),</span>
<span id="cb20-182"><a href="#cb20-182"></a>     <span class="at">new_var =</span> SAFFL,</span>
<span id="cb20-183"><a href="#cb20-183"></a>     <span class="at">condition =</span> (EXDOSE <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">|</span> (EXDOSE <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;</span> <span class="fu">str_detect</span>(EXTRT, <span class="st">"PLACEBO"</span>)))</span>
<span id="cb20-184"><a href="#cb20-184"></a>   ) <span class="sc">%&gt;%</span> </span>
<span id="cb20-185"><a href="#cb20-185"></a>   <span class="fu">drop_unspec_vars</span>(metacore) <span class="co">#This will drop any columns that aren't specified in the metacore object</span></span>
<span id="cb20-186"><a href="#cb20-186"></a></span>
<span id="cb20-187"><a href="#cb20-187"></a><span class="fu">head</span>(adsl_raw, <span class="at">n=</span><span class="dv">10</span>)</span>
<span id="cb20-188"><a href="#cb20-188"></a><span class="in">```</span></span>
<span id="cb20-189"><a href="#cb20-189"></a></span>
<span id="cb20-190"><a href="#cb20-190"></a><span class="in">```{r, warning=FALSE, message=FALSE, include=FALSE}</span></span>
<span id="cb20-191"><a href="#cb20-191"></a><span class="co"># Create dummy variables to match metacore specs to avoid later errors</span></span>
<span id="cb20-192"><a href="#cb20-192"></a><span class="co"># In practice these would be mainly created using derivation functions from admiral</span></span>
<span id="cb20-193"><a href="#cb20-193"></a>adsl_raw <span class="ot">&lt;-</span> adsl_raw <span class="sc">%&gt;%</span></span>
<span id="cb20-194"><a href="#cb20-194"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-195"><a href="#cb20-195"></a>    <span class="at">SITEGR1 =</span> <span class="cn">NA</span>,</span>
<span id="cb20-196"><a href="#cb20-196"></a>    <span class="at">TRT01PN =</span> <span class="cn">NA</span>,</span>
<span id="cb20-197"><a href="#cb20-197"></a>    <span class="at">TRT01A =</span> <span class="cn">NA</span>,</span>
<span id="cb20-198"><a href="#cb20-198"></a>    <span class="at">TRT01AN =</span> <span class="cn">NA</span>,</span>
<span id="cb20-199"><a href="#cb20-199"></a>    <span class="at">AVGDD =</span> <span class="cn">NA</span>,</span>
<span id="cb20-200"><a href="#cb20-200"></a>    <span class="at">CUMDOSE =</span> <span class="cn">NA</span>,</span>
<span id="cb20-201"><a href="#cb20-201"></a>    <span class="at">ITTFL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-202"><a href="#cb20-202"></a>    <span class="at">EFFFL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-203"><a href="#cb20-203"></a>    <span class="at">COMP8FL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-204"><a href="#cb20-204"></a>    <span class="at">COMP16FL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-205"><a href="#cb20-205"></a>    <span class="at">COMP24FL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-206"><a href="#cb20-206"></a>    <span class="at">DISCONFL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-207"><a href="#cb20-207"></a>    <span class="at">DSRAEFL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-208"><a href="#cb20-208"></a>    <span class="at">BMIBL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-209"><a href="#cb20-209"></a>    <span class="at">BMIBLGR1 =</span> <span class="cn">NA</span>,</span>
<span id="cb20-210"><a href="#cb20-210"></a>    <span class="at">HEIGHTBL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-211"><a href="#cb20-211"></a>    <span class="at">WEIGHTBL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-212"><a href="#cb20-212"></a>    <span class="at">EDUCLVL =</span> <span class="cn">NA</span>,</span>
<span id="cb20-213"><a href="#cb20-213"></a>    <span class="at">DISONSDT =</span> <span class="cn">NA</span>,</span>
<span id="cb20-214"><a href="#cb20-214"></a>    <span class="at">DURDIS =</span> <span class="cn">NA</span>,</span>
<span id="cb20-215"><a href="#cb20-215"></a>    <span class="at">DURDSGR1 =</span> <span class="cn">NA</span>,</span>
<span id="cb20-216"><a href="#cb20-216"></a>    <span class="at">VISIT1DT =</span> <span class="cn">NA</span>,</span>
<span id="cb20-217"><a href="#cb20-217"></a>    <span class="at">VISNUMEN =</span> <span class="cn">NA</span>,</span>
<span id="cb20-218"><a href="#cb20-218"></a>    <span class="at">RFENDT =</span> <span class="cn">NA</span>,</span>
<span id="cb20-219"><a href="#cb20-219"></a>    <span class="at">DCDECOD =</span> <span class="cn">NA</span>,</span>
<span id="cb20-220"><a href="#cb20-220"></a>    <span class="at">EOSSTT =</span> <span class="cn">NA</span>,</span>
<span id="cb20-221"><a href="#cb20-221"></a>    <span class="at">DCSREAS =</span> <span class="cn">NA</span>,</span>
<span id="cb20-222"><a href="#cb20-222"></a>    <span class="at">MMSETOT =</span> <span class="cn">NA</span></span>
<span id="cb20-223"><a href="#cb20-223"></a>  )</span>
<span id="cb20-224"><a href="#cb20-224"></a><span class="in">```</span></span>
<span id="cb20-225"><a href="#cb20-225"></a></span>
<span id="cb20-226"><a href="#cb20-226"></a><span class="fu">## Apply Metadata to Create an eSub XPT and Perform Associated Checks</span></span>
<span id="cb20-227"><a href="#cb20-227"></a></span>
<span id="cb20-228"><a href="#cb20-228"></a>Now we have all the variables defined we can run some checks before applying the</span>
<span id="cb20-229"><a href="#cb20-229"></a>necessary formatting.</span>
<span id="cb20-230"><a href="#cb20-230"></a>The top four functions performing checks and sorting/ordering come from</span>
<span id="cb20-231"><a href="#cb20-231"></a><span class="in">`{metatools}`</span>, whereas the others focused around applying attributes to prepare</span>
<span id="cb20-232"><a href="#cb20-232"></a>for XPT come from <span class="in">`{xportr}`</span>. At the end you could add a call to</span>
<span id="cb20-233"><a href="#cb20-233"></a><span class="in">`xportr::xportr_write()`</span> to produce the XPT file.</span>
<span id="cb20-234"><a href="#cb20-234"></a></span>
<span id="cb20-235"><a href="#cb20-235"></a><span class="in">```{r checks, warning=FALSE, message=FALSE}</span></span>
<span id="cb20-236"><a href="#cb20-236"></a></span>
<span id="cb20-237"><a href="#cb20-237"></a>adsl_raw <span class="sc">%&gt;%</span> </span>
<span id="cb20-238"><a href="#cb20-238"></a>   <span class="fu">check_variables</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Check all variables specified are present and no more</span></span>
<span id="cb20-239"><a href="#cb20-239"></a>   <span class="fu">check_ct_data</span>(metacore, <span class="at">na_acceptable =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="co"># Checks all variables with CT only contain values within the CT</span></span>
<span id="cb20-240"><a href="#cb20-240"></a>   <span class="fu">order_cols</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Orders the columns according to the spec</span></span>
<span id="cb20-241"><a href="#cb20-241"></a>   <span class="fu">sort_by_key</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Sorts the rows by the sort keys </span></span>
<span id="cb20-242"><a href="#cb20-242"></a>   <span class="fu">xportr_type</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Coerce variable type to match spec</span></span>
<span id="cb20-243"><a href="#cb20-243"></a>   <span class="fu">xportr_length</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Assigns SAS length from a variable level metadata </span></span>
<span id="cb20-244"><a href="#cb20-244"></a>   <span class="fu">xportr_label</span>(metacore) <span class="sc">%&gt;%</span> <span class="co"># Assigns variable label from metacore specifications </span></span>
<span id="cb20-245"><a href="#cb20-245"></a>   <span class="fu">xportr_df_label</span>(metacore) <span class="co"># Assigns dataset label from metacore specifications</span></span>
<span id="cb20-246"><a href="#cb20-246"></a><span class="in">```</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
  </div>
</footer>


<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>